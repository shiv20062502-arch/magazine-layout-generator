<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazine Layout Generator - Custom Split Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --secondary: #f5f5f5;
            --accent: #2563eb;
            --border: #e5e5e5;
            --text: #333;
            --text-light: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 60px 20px 40px;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -0.5px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            margin: 40px 0;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: white;
            padding: 30px;
            border-radius: 8px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border);
        }

        .section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--secondary);
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: #f0f7ff;
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: #e0f2fe;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #333;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e5e5;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select, input[type="text"], input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            margin-bottom: 12px;
            background: white;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            background: var(--secondary);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }

        .radio-option.selected {
            border-color: var(--accent);
            background: #f0f7ff;
        }

        .preview-area {
            background: white;
            padding: 40px;
            border-radius: 8px;
            min-height: 600px;
        }

        .empty-state {
            text-align: center;
            color: var(--text-light);
            padding: 100px 20px;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Interactive Canvas */
        .canvas-container {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        #interactiveCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }

        .split-line {
            position: absolute;
            background: rgba(37, 99, 235, 0.6);
            z-index: 10;
            cursor: move;
            transition: background 0.2s;
        }

        .split-line:hover {
            background: rgba(37, 99, 235, 0.9);
        }

        .split-line.horizontal {
            height: 3px;
            width: 100%;
            left: 0;
        }

        .split-line.vertical {
            width: 3px;
            height: 100%;
            top: 0;
        }

        .split-line .handle {
            position: absolute;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--accent);
            font-weight: bold;
        }

        .split-line.horizontal .handle {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .split-line.vertical .handle {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .split-line .label {
            position: absolute;
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .split-line.horizontal .label {
            left: 10px;
            top: -25px;
        }

        .split-line.vertical .label {
            top: 10px;
            left: 10px;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .page-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: white;
        }

        .page-card:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .page-card canvas {
            width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .page-number {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .range-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .image-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .image-info strong {
            color: var(--accent);
        }

        .magazine-viewer {
            margin-top: 30px;
            padding: 30px;
            background: #2a2a2a;
            border-radius: 12px;
        }

        .flipbook-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .page-display {
            background: white;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .page-display img {
            width: 100%;
            height: auto;
            display: block;
        }

        .flip-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .flip-controls button {
            padding: 12px 24px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .flip-controls button:hover:not(:disabled) {
            background: var(--accent);
            color: white;
        }

        .flip-controls button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-indicator {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 6px;
            font-weight: 500;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
            line-height: 1.5;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .checkbox-option input {
            margin-right: 10px;
        }

        .instruction-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.85rem;
            color: #92400e;
        }

        .instruction-box strong {
            display: block;
            margin-bottom: 5px;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-toggle button {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .mode-toggle button.active {
            border-color: var(--accent);
            background: #f0f7ff;
            color: var(--accent);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header>
        <h1>‚úÇÔ∏è Magazine Page Splitter</h1>
        <p class="subtitle">Upload, adjust cuts manually, and create printable magazine pages</p>
    </header>

    <div class="container">
        <div class="main-content">
            <aside class="sidebar">
                <div class="section">
                    <h2 class="section-title">üì§ Upload Image</h2>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <p><strong>Drop your image here</strong></p>
                        <p class="help-text">or click to browse<br>Supports: JPG, PNG, WebP</p>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                    <div id="imageInfo" class="image-info" style="display: none;"></div>
                </div>

                <div class="section" id="splitModeSection" style="display: none;">
                    <h2 class="section-title">üéØ Split Mode</h2>
                    <div class="mode-toggle">
                        <button id="autoModeBtn" class="active">Auto Split</button>
                        <button id="manualModeBtn">Manual Cut</button>
                    </div>
                    <p class="help-text" id="modeHelp">Automatic even splitting</p>
                </div>

                <div class="section" id="autoSettings">
                    <h2 class="section-title">üìè Magazine Size</h2>
                    <select id="sizeSelect">
                        <option value="a4">A4 (210 √ó 297 mm)</option>
                        <option value="a5">A5 (148 √ó 210 mm)</option>
                        <option value="letter">US Letter (8.5 √ó 11 in)</option>
                    </select>

                    <h2 class="section-title" style="margin-top: 20px;">‚úÇÔ∏è Split Direction</h2>
                    <div class="radio-group">
                        <label class="radio-option selected">
                            <input type="radio" name="direction" value="vertical" checked>
                            <div>
                                <strong>Vertical</strong>
                                <div class="help-text">Top to bottom</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="direction" value="horizontal">
                            <div>
                                <strong>Horizontal</strong>
                                <div class="help-text">Left to right</div>
                            </div>
                        </label>
                    </div>

                    <h2 class="section-title" style="margin-top: 20px;">üìÑ Number of Pages</h2>
                    <div class="range-label">
                        <span>2</span>
                        <span id="pagesValue">4 pages</span>
                        <span>12</span>
                    </div>
                    <input type="range" id="pagesSlider" min="2" max="12" value="4" step="1">
                </div>

                <div class="section">
                    <h2 class="section-title">üé® Customization</h2>
                    <input type="text" id="titleInput" placeholder="Magazine title (optional)">
                    <div class="checkbox-option">
                        <input type="checkbox" id="pageNumbersCheck" checked>
                        <label for="pageNumbersCheck">Show page numbers</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="marginsCheck" checked>
                        <label for="marginsCheck">Add print margins</label>
                    </div>
                </div>

                <div class="section">
                    <button class="btn btn-primary" id="applySplitBtn" disabled>‚úÇÔ∏è Apply Split</button>
                    <button class="btn btn-success" id="generateBtn" disabled>üìÑ Generate Pages</button>
                    <button class="btn btn-accent" id="previewBtn" disabled>üëÅÔ∏è Preview Magazine</button>
                    <button class="btn btn-secondary" id="downloadBtn" disabled>üì• Download PDF</button>
                    <div class="info-badge" style="margin-top: 15px; display: block; text-align: center;">
                        ‚úì Print-ready ‚Ä¢ 300 DPI
                    </div>
                </div>
            </aside>

            <main class="preview-area">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">üìÑ</div>
                    <h3>Upload an image to get started</h3>
                    <p style="margin-top: 10px;">Split it into magazine-sized pages</p>
                </div>

                <div id="interactiveSection" style="display: none;">
                    <div class="instruction-box" id="instructionBox">
                        <strong>üìç Auto Mode:</strong>
                        Adjust the number of pages using the slider. Click "Apply Split" to see the cuts.
                    </div>
                    
                    <div style="text-align: center;">
                        <div class="canvas-container" id="canvasContainer">
                            <canvas id="interactiveCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p><strong>Generating your magazine pages...</strong></p>
                </div>

                <div id="pagesPreview" style="display: none;">
                    <h3 style="margin-bottom: 20px;">üìö Magazine Pages (<span id="pageCount">0</span> pages)</h3>
                    <div class="pages-grid" id="pagesGrid"></div>
                </div>

                <div id="magazineViewer" class="magazine-viewer" style="display: none;">
                    <div class="flipbook-container">
                        <div class="page-display" id="pageDisplay"></div>
                        <div class="flip-controls">
                            <button id="prevPage">‚Üê Previous</button>
                            <div class="page-indicator" id="pageIndicator">Page 1</div>
                            <button id="nextPage">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <footer>
        <p><strong>Magazine Page Splitter</strong> - Manual cut adjustment for perfect magazine pages</p>
        <p style="margin-top: 10px; font-size: 0.85rem;">Drag the blue lines to adjust where your image splits</p>
    </footer>

    <script>
        const state = {
            uploadedImage: null,
            mode: 'auto', // 'auto' or 'manual'
            direction: 'vertical',
            size: 'a4',
            numPages: 4,
            splitPositions: [],
            pages: [],
            title: '',
            pageNumbers: true,
            margins: true,
            currentPage: 0
        };

        const sizes = {
            a4: { width: 210, height: 297, dpi: 300 },
            a5: { width: 148, height: 210, dpi: 300 },
            letter: { width: 215.9, height: 279.4, dpi: 300 }
        };

        const printConfig = { margin: 10, bleed: 3 };

        // DOM elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const splitModeSection = document.getElementById('splitModeSection');
        const autoModeBtn = document.getElementById('autoModeBtn');
        const manualModeBtn = document.getElementById('manualModeBtn');
        const modeHelp = document.getElementById('modeHelp');
        const instructionBox = document.getElementById('instructionBox');
        const applySplitBtn = document.getElementById('applySplitBtn');
        const generateBtn = document.getElementById('generateBtn');
        const previewBtn = document.getElementById('previewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const pagesSlider = document.getElementById('pagesSlider');
        const pagesValue = document.getElementById('pagesValue');
        const emptyState = document.getElementById('emptyState');
        const interactiveSection = document.getElementById('interactiveSection');
        const canvas = document.getElementById('interactiveCanvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');
        const imageInfo = document.getElementById('imageInfo');
        const loading = document.getElementById('loading');
        const pagesPreview = document.getElementById('pagesPreview');
        const pagesGrid = document.getElementById('pagesGrid');
        const magazineViewer = document.getElementById('magazineViewer');

        // Upload handling
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.uploadedImage = {
                        src: e.target.result,
                        width: img.width,
                        height: img.height,
                        element: img
                    };
                    
                    displayInteractiveCanvas();
                    splitModeSection.style.display = 'block';
                    applySplitBtn.disabled = false;
                    
                    const orientation = img.width > img.height ? 'Landscape' : 'Portrait';
                    imageInfo.style.display = 'block';
                    imageInfo.innerHTML = `
                        <strong>Image Info:</strong><br>
                        Size: ${img.width} √ó ${img.height} px<br>
                        Orientation: ${orientation}
                    `;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Mode toggle
        autoModeBtn.addEventListener('click', () => {
            state.mode = 'auto';
            autoModeBtn.classList.add('active');
            manualModeBtn.classList.remove('active');
            modeHelp.textContent = 'Automatic even splitting';
            instructionBox.innerHTML = '<strong>üìç Auto Mode:</strong> Adjust the number of pages using the slider. Click "Apply Split" to see the cuts.';
            if (state.uploadedImage) displayInteractiveCanvas();
        });

        manualModeBtn.addEventListener('click', () => {
            state.mode = 'manual';
            manualModeBtn.classList.add('active');
            autoModeBtn.classList.remove('active');
            modeHelp.textContent = 'Drag lines to adjust cuts';
            instructionBox.innerHTML = '<strong>üñ±Ô∏è Manual Mode:</strong> Drag the blue lines to adjust where your image splits. Click anywhere to add new cut lines.';
            if (state.uploadedImage) displayInteractiveCanvas();
        });

        // Settings
        document.querySelectorAll('input[name="direction"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.direction = e.target.value;
                document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
                e.target.closest('.radio-option').classList.add('selected');
                if (state.uploadedImage) displayInteractiveCanvas();
            });
        });

        document.getElementById('sizeSelect').addEventListener('change', (e) => {
            state.size = e.target.value;
        });

        pagesSlider.addEventListener('input', (e) => {
            state.numPages = parseInt(e.target.value);
            pagesValue.textContent = `${state.numPages} pages`;
            if (state.mode === 'auto' && state.uploadedImage) {
                displayInteractiveCanvas();
            }
        });

        document.getElementById('titleInput').addEventListener('input', (e) => {
            state.title = e.target.value;
        });

        document.getElementById('pageNumbersCheck').addEventListener('change', (e) => {
            state.pageNumbers = e.target.checked;
        });

        document.getElementById('marginsCheck').addEventListener('change', (e) => {
            state.margins = e.target.checked;
        });

        // Display interactive canvas
        function displayInteractiveCanvas() {
            emptyState.style.display = 'none';
            interactiveSection.style.display = 'block';
            pagesPreview.style.display = 'none';
            magazineViewer.style.display = 'none';

            const img = state.uploadedImage.element;
            const maxWidth = 800;
            const scale = Math.min(maxWidth / img.width, 1);
            
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Calculate split positions
            if (state.mode === 'auto') {
                state.splitPositions = [];
                const numSplits = state.numPages - 1;
                
                if (state.direction === 'vertical') {
                    for (let i = 1; i <= numSplits; i++) {
                        state.splitPositions.push((canvas.height / state.numPages) * i);
                    }
                } else {
                    for (let i = 1; i <= numSplits; i++) {
                        state.splitPositions.push((canvas.width / state.numPages) * i);
                    }
                }
            }

            drawSplitLines();
        }

        function drawSplitLines() {
            // Clear existing lines
            const existingLines = canvasContainer.querySelectorAll('.split-line');
            existingLines.forEach(line => line.remove());

            // Draw new lines
            state.splitPositions.forEach((pos, index) => {
                const line = document.createElement('div');
                line.className = `split-line ${state.direction === 'vertical' ? 'horizontal' : 'vertical'}`;
                line.dataset.index = index;

                if (state.direction === 'vertical') {
                    line.style.top = pos + 'px';
                } else {
                    line.style.left = pos + 'px';
                }

                const handle = document.createElement('div');
                handle.className = 'handle';
                handle.textContent = '‚ãÆ';
                line.appendChild(handle);

                const label = document.createElement('div');
                label.className = 'label';
                label.textContent = `Cut ${index + 1}`;
                line.appendChild(label);

                canvasContainer.appendChild(line);

                // Make draggable
                makeDraggable(line, index);
            });
        }

        function makeDraggable(element, index) {
            let isDragging = false;

            element.addEventListener('mousedown', (e) => {
                if (state.mode === 'manual') {
                    isDragging = true;
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const rect = canvasContainer.getBoundingClientRect();
                
                if (state.direction === 'vertical') {
                    let newTop = e.clientY - rect.top;
                    newTop = Math.max(20, Math.min(newTop, canvas.height - 20));
                    state.splitPositions[index] = newTop;
                    element.style.top = newTop + 'px';
                } else {
                    let newLeft = e.clientX - rect.left;
                    newLeft = Math.max(20, Math.min(newLeft, canvas.width - 20));
                    state.splitPositions[index] = newLeft;
                    element.style.left = newLeft + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // Add new split line on click (manual mode)
        canvas.addEventListener('click', (e) => {
            if (state.mode !== 'manual') return;

            const rect = canvas.getBoundingClientRect();
            
            if (state.direction === 'vertical') {
                const y = e.clientY - rect.top;
                state.splitPositions.push(y);
            } else {
                const x = e.clientX - rect.left;
                state.splitPositions.push(x);
            }

            state.splitPositions.sort((a, b) => a - b);
            drawSplitLines();
        });

        // Apply split
        applySplitBtn.addEventListener('click', () => {
            if (state.splitPositions.length === 0) {
                alert('Please add at least one split line!');
                return;
            }
            generateBtn.disabled = false;
        });

        // Generate pages
        generateBtn.addEventListener('click', generatePages);

        function generatePages() {
            if (!state.uploadedImage) return;

            loading.style.display = 'block';
            interactiveSection.style.display = 'none';
            pagesPreview.style.display = 'none';
            magazineViewer.style.display = 'none';

            setTimeout(() => {
                state.pages = [];
                const img = state.uploadedImage.element;
                const size = sizes[state.size];
                const mmToPx = (mm) => (mm / 25.4) * size.dpi;
                
                const pageWidth = mmToPx(size.width);
                const pageHeight = mmToPx(size.height);
                const margin = state.margins ? mmToPx(printConfig.margin) : 0;

                // Calculate actual split positions on original image
                const scaleToOriginal = img.width / canvas.width;
                const actualSplits = state.splitPositions.map(pos => pos * scaleToOriginal);
                
                // Add start and end positions
                const allPositions = [0, ...actualSplits, state.direction === 'vertical' ? img.height : img.width];

                for (let i = 0; i < allPositions.length - 1; i++) {
                    const pageCanvas = document.createElement('canvas');
                    const pageCtx = pageCanvas.getContext('2d');
                    
                    pageCanvas.width = pageWidth;
                    pageCanvas.height = pageHeight;

                    pageCtx.fillStyle = '#ffffff';
                    pageCtx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

                    let sx, sy, sWidth, sHeight;
                    
                    if (state.direction === 'vertical') {
                        sx = 0;
                        sy = allPositions[i];
                        sWidth = img.width;
                        sHeight = allPositions[i + 1] - allPositions[i];
                    } else {
                        sx = allPositions[i];
                        sy = 0;
                        sWidth = allPositions[i + 1] - allPositions[i];
                        sHeight = img.height;
                    }

                    const contentWidth = pageCanvas.width - (margin * 2);
                    const contentHeight = pageCanvas.height - (margin * 2);
                    
                    const scale = Math.min(contentWidth / sWidth, contentHeight / sHeight);
                    const dWidth = sWidth * scale;
                    const dHeight = sHeight * scale;
                    const dx = margin + (contentWidth - dWidth) / 2;
                    const dy = margin + (contentHeight - dHeight) / 2;

                    pageCtx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

                    if (state.title && i === 0) {
                        pageCtx.fillStyle = '#1a1a1a';
                        pageCtx.font = `bold ${mmToPx(6)}px serif`;
                        pageCtx.textAlign = 'center';
                        pageCtx.fillText(state.title.toUpperCase(), pageCanvas.width / 2, margin + mmToPx(4));
                    }

                    if (state.pageNumbers) {
                        pageCtx.fillStyle = '#666666';
                        pageCtx.font = `${mmToPx(3)}px sans-serif`;
                        pageCtx.textAlign = 'center';
                        pageCtx.fillText(`${i + 1}`, pageCanvas.width / 2, pageCanvas.height - margin / 2);
                    }

                    state.pages.push(pageCanvas);
                }

                displayPages();
                loading.style.display = 'none';
                previewBtn.disabled = false;
                downloadBtn.disabled = false;
            }, 500);
        }

        function displayPages() {
            pagesPreview.style.display = 'block';
            document.getElementById('pageCount').textContent = state.pages.length;
            
            pagesGrid.innerHTML = state.pages.map((pageCanvas, i) => {
                const previewCanvas = document.createElement('canvas');
                const ctx = previewCanvas.getContext('2d');
                const scale = 200 / Math.max(pageCanvas.width, pageCanvas.height);
                previewCanvas.width = pageCanvas.width * scale;
                previewCanvas.height = pageCanvas.height * scale;
                ctx.drawImage(pageCanvas, 0, 0, previewCanvas.width, previewCanvas.height);
                
                return `
                    <div class="page-card" onclick="showPage(${i})">
                        <img src="${previewCanvas.toDataURL()}" alt="Page ${i + 1}">
                        <div class="page-number">Page ${i + 1}</div>
                    </div>
                `;
            }).join('');
        }

        // Magazine preview
        previewBtn.addEventListener('click', () => showPage(0));

        window.showPage = function(pageIndex) {
            state.currentPage = pageIndex;
            pagesPreview.style.display = 'none';
            interactiveSection.style.display = 'none';
            magazineViewer.style.display = 'block';
            
            const pageDisplay = document.getElementById('pageDisplay');
            pageDisplay.innerHTML = `<img src="${state.pages[pageIndex].toDataURL()}" alt="Page ${pageIndex + 1}">`;
            
            updatePageIndicator();
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (state.currentPage > 0) {
                showPage(state.currentPage - 1);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (state.currentPage < state.pages.length - 1) {
                showPage(state.currentPage + 1);
            }
        });

        function updatePageIndicator() {
            const indicator = document.getElementById('pageIndicator');
            indicator.textContent = `Page ${state.currentPage + 1} of ${state.pages.length}`;
            
            document.getElementById('prevPage').disabled = state.currentPage === 0;
            document.getElementById('nextPage').disabled = state.currentPage === state.pages.length - 1;
        }

        // Download PDF
        downloadBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const size = sizes[state.size];
            const pdf = new jsPDF({
                orientation: size.width > size.height ? 'landscape' : 'portrait',
                unit: 'mm',
                format: [size.width, size.height],
                compress: true
            });

            state.pages.forEach((pageCanvas, i) => {
                if (i > 0) pdf.addPage();
                const imgData = pageCanvas.toDataURL('image/jpeg', 1.0);
                pdf.addImage(imgData, 'JPEG', 0, 0, size.width, size.height, '', 'FAST');
            });
            
            const filename = state.title ? 
                `${state.title.replace(/[^a-z0-9]/gi, '_')}_magazine.pdf` : 
                `magazine_${state.pages.length}_pages.pdf`;
            
            pdf.save(filename);
        });
    </script>
</body>
</html>